<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>NIMIQ.WATCH</title>

    <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">

    <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:400,700" rel="stylesheet">
    <style>
        body {
            background: white;
            color: #444;
            font-family: "Source Sans Pro", sans-serif;
            font-size: 18px;
            letter-spacing: 0.02em;
            padding: 0;
            margin: 0;
        }

        a {
            color: #042146;
        }

        header {
            background: #042146;
            color: white;
            padding: 0.5em 0.8em;
            overflow: auto;
        }

        header a {
            color: inherit;
            text-decoration: inherit;
        }

        header h1 {
            margin: 0.2em 0;
            float: left;
            font-size: 1.5em;
            letter-spacing: 0.05em;
        }

        header .nimiq-logo {
            position: relative;
            top: 0.2em;
        }

        #monitor {
            float: right;
            line-height: 2.5em;
        }

        .not-connected {
            color: red;
        }

        .synchronizing {
            color: gold;
        }

        .consensus-established {
            color: limegreen;
        }

        img.nimiq_currency {
            height: 12px;
        }

        #search {
            max-width: 800px;
            margin: 2em auto;
            padding: 0 20px;
        }

        #search h1 {
            font-weight: normal;
            text-align: center;
        }

        #search-form input {
            font-size: inherit;
            font-family: "Source Code Pro", monospace;
            padding: 1em;
            border-radius: 3px;
            border: 1px solid #042146;
        }

        #search-input {
            width: 83%;
        }

        #search-submit {
            width: 10%;
            text-transform: uppercase;
            cursor: pointer;
            font-weight: bold;
            min-width: 60px;
        }
        #search-submit:disabled {
            cursor: auto;
        }

        #search-form .detection {
            font-size: 16px;
        }

        #hash-format {
            font-weight: bold;
            margin-left: 0.2em;
        }

        hash {
            font-family: "Source Code Pro", monospace;
            font-size: 16px;
            letter-spacing: -0.02em;
            text-transform: uppercase;
        }

        #infobox {
            width: 850px;
            margin: 2em auto;
            padding: 0 20px;
        }

        #infobox h2,
        #infobox h3 {
            font-weight: normal;
            text-transform: uppercase;
            margin-bottom: 0.2em;
        }

        #infobox h3 {
            font-weight: bold;
            font-size: 16px;
            color: #888;
        }

        #infobox img {
            height: 12px;
        }

        .blockinfo-header {
            overflow: auto;
            border: 1px solid;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        .blockinfo-header .height {
            float: left;
            width: 200px;
            padding: 0 1em 1em 1em;
        }

        .blockinfo-header .height span {
            font-size: 40px;
        }

        .blockinfo-header .hash {
            float: left;
        }

        .blockinfo-body {
            overflow: auto;
            border-left: 1px solid;
            border-right: 1px solid;
        }

        .blockinfo-body-left,
        .blockinfo-body-right {
            float: left;
            width: 50%;
            box-sizing: border-box;
            padding: 1em;
        }

        .blockinfo-miner {
            clear: both;
            border-top: 1px solid;
        }

        .blockinfo-transactions {
            border: 1px solid;
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }

        .blockinfo-transaction-header-row {
            display: table-row;
        }

        .blockinfo-transaction-header-row h3 {
            display: table-cell;
        }

        .blockinfo-transaction-row {
            display: table-row;
        }

        .blockinfo-transaction-row > * {
            display: table-cell;
        }

        .no-transactions {
            text-align: center;
            padding: 1em;
            text-transform: uppercase;
            color: #AAA;
        }

        #blocklist-wrapper {
            max-width: 1050px;
            margin: 2em auto;
            padding: 0 20px;
        }

        #blocklist-wrapper h2 {
            font-weight: normal;
            text-transform: uppercase;
            margin-bottom: 0.2em;
        }

        #blocklist {
            display: table;
            border-spacing: 0 8px;
            width: 100%;
        }

        .blocklist-block {
            display: table-row;
            background: #D6D6D6;
        }

        .blocklist-cell {
            display: table-cell;
            padding: 0.6em 1em;
            white-space: nowrap;
        }
        .blocklist-cell:first-child {
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
        }
        .blocklist-cell:last-child {
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
        }

        .blocklist-loader {
            width: 34px;
            height: 30px;

            margin: auto;
            animation: sk-rotateplane 1.2s infinite ease-in-out;
        }

        @keyframes sk-rotateplane {
            0%   { transform: perspective(120px) rotateX(0deg) rotateY(0deg); }
            50%  { transform: perspective(120px) rotateX(-180.1deg) rotateY(0deg); }
            100% { transform: perspective(120px) rotateX(-180deg) rotateY(-179.9deg); }
        }

        .ellipsis {
            text-overflow: ellipsis;
            overflow: hidden;
            width: 100%;
            max-width: 1px; /* enables the correct overflow behaviour */
        }

        footer {
            text-align: center;
            font-size: 14px;
            color: #AAA;
            padding: 1em;
        }
        footer a {
            color: #888;
        }
    </style>

    <script type="text/javascript" src="https://cdn.nimiq.com/core/nimiq.js"></script>
    <script>

        function _onConsensusEstablished() {
            document.getElementById('status').innerText = 'consensus established';
            document.getElementById('status').classList.add('consensus-established');
            document.getElementById('search-submit').removeAttribute('disabled');
            document.getElementById('search-submit').removeAttribute('title');

            _buildListOfLatestBlocks();
        }

        function _onConsensusLost() {
            console.error('Consensus lost');
            document.getElementById('status').innerText = 'consensus lost';
            document.getElementById('status').classList.remove('consensus-established', 'synchronizing');
        }

        function _onHeadChanged() {
            const height = $.blockchain.height;
            document.getElementById('height').innerText = '#' + height;

            if(blocklistBuilt) {
                _getBlockInfo($.blockchain.headHash, function(blockInfo) {
                    _addBlockToListOfLatestBlocks(blockInfo);
                });
            }
        }

        function _onPeersChanged() {
            document.getElementById('monitor').setAttribute('title', 'Connected to ' + $.network.peerCount + ' peers');
        }

        Nimiq.init($ => {
            document.getElementById('status').innerText = 'synchronizing';
            document.getElementById('status').classList.add('synchronizing');

            window.$ = $;

            $.consensus.on('established',   () => _onConsensusEstablished());
            $.consensus.on('lost',          () => _onConsensusLost());

            $.blockchain.on('head-changed', () => _onHeadChanged()); _onHeadChanged();

            $.network.on('peers-changed',   () => _onPeersChanged());

            $.network.connect();
        }, function(error) {
            console.error(error);
            alert(error);
        });

        // Dummy object to prevent JS errors
        window.$ = {
            consensus: {
                established: false
            }
        };
    </script>
    <script src="vendor/tmpl.min.js"></script>
</head>
<body>
    <header>
        <h1>
            <a href="//nimiq.watch">
                <span class="nimiq-logo">
                    <svg fill="#F6AE2D" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
                </span>
                NIMIQ.WATCH
            </a>
        </h1>
        <span id="monitor" title="Connected to 0 peers">
            <strong>Status:</strong>
            <span id="status" class="not-connected">not connected</span> @ <span id="height"><em>loading</em></span>
        </span>
    </header>

    <div id="search">
        <h1>Search accounts and blocks by hash:</h1>

        <form action="#search" method="GET" id="search-form">
            <input type="text" id="search-input" placeholder="hex format" onfocus="this.select();" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <input type="submit" id="search-submit" value="go" disabled="" title="Consensus not established">
            <span class="detection">Format detected: <span id="hash-format"><em>none</em></span></span>
        </form>
    </div>

    <div id="infobox">
    </div>

    <div id="blocklist-wrapper">
        <h2>Latest blocks</h2>
        <div id="blocklist">
            <div class="blocklist-block">
                <div class="blocklist-cell">
                    <div class="blocklist-loader">
                        <svg fill="#F6AE2D" xmlns="http://www.w3.org/2000/svg" width="34" height="30"><path d="M25.2 1H8.8l-8 14 8 14h16.4l8-14-8-14zm-6.7 22V26H16v-2.6c-1.5 0-3.3-.8-4.5-2l1.7-2.4c1.3 1 2.4 1.5 3.6 1.5 1.4 0 2-.6 2-1.7 0-2.6-6.7-2.6-6.7-7 0-2.6 1.6-4.3 4-4.8V4.2h2.5v2.6c1.6.2 2.8 1 3.8 2l-2 2.2c-.8-1-1.6-1.3-2.7-1.3-1.2 0-2 .5-2 1.6.2 2.4 7 2.2 7 7 0 2.4-1.5 4.3-4 4.8z"></path></svg>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        This web application is built on top of the <a target="_blank" href="https://nimiq.com">Nimiq Blockchain</a>.
        <a target="_blank" href="https://github.com/sisou/nimiq-watch">View Source Code on Github.</a>
    </footer>

    <script type="text/x-tmpl" id="template-block-info">
        <h2>Block Info</h2>
        <div class="blockinfo-header">
            <div class="height">
                <h3>Height</h3>
                <span>#{%=o.height%}</span>
            </div>
            <div class="hash">
                <h3>Hash</h3>
                <hash>{%=o.hash%}</hash>
            </div>
        </div>
        <div class="blockinfo-body">
            <div class="blockinfo-body-left">
                <div class="blockinfo-body-row">
                    <label>Transactions</label>
                    <span>{%=o.transactionCount%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Transaction Value</label>
                    <span><img src="icons/nimiq_blue.svg"> {%=o.transactionValue%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Difficulty</label>
                    <span>{%=o.difficulty%}</span>
                </div>
            </div>
            <div class="blockinfo-body-right">
                <div class="blockinfo-body-row">
                    <label>Timestamp</label>
                    <span>{%=o.timestamp%}</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Size</label>
                    <span>{%=o.serializedSize%} Bytes</span>
                </div>
                <div class="blockinfo-body-row">
                    <label>Nonce</label>
                    <span>{%=o.nonce%}</span>
                </div>
            </div>
            <div class="blockinfo-miner">
                <label>Mined by</label>
                <hash>{%=o.minerAddr%}</hash>
            </div>
        </div>
        <div class="blockinfo-transactions">
            {% if(o.transactionCount) { %}
                <div class="blockinfo-transaction-header-row">
                    <h3>Sender</h3>
                    <h3>Receiver</h3>
                    <h3>Amount</h3>
                </div>
                {% for(var i = 0; i < o.transactions.length; i++) { %}
                    <div class="blockinfo-transaction-row">
                        <hash id="{% var elementId = 'sender-address-' + i; _getAndWriteSenderAddressHash(o.transactions[i], elementId); print(elementId); %}"></hash>
                        <hash>{%=o.transactions[i].recipientAddr.toHex()%}</hash>
                        <span><img src="icons/nimiq_blue.svg"> {%=Nimiq.Policy.satoshisToCoins(o.transactions[i].value)%}</span>
                    </div>
                {% } %}
            {% } else { %}
                <div class="no-transactions">No transactions</div>
            {% } %}
        </div>
    </script>

    <script type="text/x-tmpl" id="template-account-info">
    </script>

    <script type="text/x-tmpl" id="template-blocklist-block">
        <div class="blocklist-cell">
            #{%=o.height%}
        </div>
        <div class="blocklist-cell">
            {% var time = new Date(o.timestamp * 1000); print(time.toLocaleTimeString()); %}
        </div>
        <div class="blocklist-cell">
            {%=o.transactionCount%} {% if(o.transactionCount === 1) print('transaction'); else print('transactions'); %}
        </div>
        <div class="blocklist-cell ellipsis">
            found by <hash>{%=o.minerAddr%}</hash>
        </div>
        <div class="blocklist-cell">
            {%=o.serializedSize%} Bytes
        </div>
    </script>

    <script>
        var accountHashRegExp = new RegExp('^[A-Fa-f0-9]{40}$'),
            blockHashRegExp   = new RegExp('^[A-Fa-f0-9]{64}$');

        var tmpl = {
            blocklistBlock: tmpl('template-blocklist-block'),
            blockInfo: tmpl('template-block-info'),
            accountInfo: tmpl('template-account-info')
        }

        function _detectHashFormat(value) {
            if(accountHashRegExp.test(value)) {
                return "Account Hash";
            }
            else if(blockHashRegExp.test(value) && value[0] === "0" && value[1] === "0") {
                return "Block Hash";
            }
            else if(value.match(/^[0-9]*$/) && parseInt(value)) {
                return "Block Number"
            }
        }

        function _getBlockInfo(hash, callback) {
            if(typeof hash === "string") {
                hash = Nimiq.Hash.fromHex(hash);
            }

            $.blockchain.getBlock(hash).then(function(block) {
                if(!block) {
                    callback(null);
                    return;
                }

                block.hash().then(function(hash) {
                    callback({
                        hash:             hash.toHex(),
                        height:           block.height,
                        timestamp:        block.timestamp,
                        difficulty:       block.difficulty,
                        serializedSize:   block.serializedSize,
                        minerAddr:        block.minerAddr.toHex(),
                        transactionCount: block.transactionCount,
                        transactions:     block.transactions,
                        transactionValue: Nimiq.Policy.satoshisToCoins(block.transactions.reduce(function(acc, tx) { return tx.value + acc; }, 0)),
                        prevHash:         block.prevHash.toHex(),
                        nonce:            block.nonce
                    });
                });
            });
        }

        function _getAndWriteSenderAddressHash(tx, elementId) {
            tx.getSenderAddr().then(function(address) {
                document.getElementById(elementId).innerText = address.toHex();
            });
        }

        var blocklistBuilt = false;
        var latestBlocks = [];

        function _buildListOfLatestBlocks() {
            if(blocklistBuilt !== false) return;
            blocklistBuilt = null;

            var _accumulateBlocks = function(blockInfo) {
                latestBlocks.push(blockInfo);

                if(latestBlocks.length === 20) {
                    latestBlocks.sort(function(a, b) {
                        if(a.height < b.height) return -1;
                        else return 1;
                    });

                    blocklistNode.removeChild(blocklistNode.getElementsByTagName('div')[0]);

                    for(var i = 0; i < latestBlocks.length; i++ ) {
                        _addBlockToListOfLatestBlocks(latestBlocks[i]);
                    }

                    delete latestBlocks;
                    blocklistBuilt = true;
                }
            }

            var hashes = $.blockchain.path.slice(-20);

            // Query all blocks' info
            for(var i = 0; i < hashes.length; i++) {
                _getBlockInfo(hashes[i], _accumulateBlocks);
            }
        }

        var blocklistNode = document.getElementById('blocklist');

        function _addBlockToListOfLatestBlocks(blockInfo) {
            var item = document.createElement('div');
            item.classList.add('blocklist-block');

            item.innerHTML = tmpl.blocklistBlock(blockInfo);

            blocklistNode.insertBefore(item, blocklistNode.firstChild);
        }

        document.getElementById('search-input').addEventListener('input', function(e) {
            document.getElementById('hash-format').innerHTML = _detectHashFormat(this.value) || "<em>none</em>";
        });

        document.getElementById('search-form').addEventListener('submit', function(e) {
            e.preventDefault();

            if(!$.consensus.established) return;

            var value = document.getElementById('search-input').value;
            var format = _detectHashFormat(value);

            switch(format) {
                case "Account Hash":
                    $.accounts.getBalance(Nimiq.Address.fromHex(value)).then(function(balance) {
                        var accountInfo = {
                            balance: Nimiq.Policy.satoshisToCoins(balance.value),
                            nonce: balance.nonce
                        };
                        alert("Balance: " + accountInfo.balance + ", Nonce: " + accountInfo.nonce);
                    });
                    break;
                case "Block Hash":
                    // 0000000FB8DDCB2A2239B31FB268A716DC4D58C616A94319746A3E81539349A0
                    // 00000000A30C2FC0A05822A7C1255FB7657CCAC7861B85742134C48E6968A42B
                    _getBlockInfo(value, function(blockInfo) {
                        if(!blockInfo) {
                            alert("That block cannot be found.\n\nIt my be out of reach due to the temporary checkpoint solution. Lowest possible block: " + $.blockchain.path[0].toHex())
                        }
                        // console.log(blockInfo);

                        document.getElementById('infobox').innerHTML = tmpl.blockInfo(blockInfo);
                    });
                    break;
                case "Block Number":
                    var currentHeight = $.blockchain.head.height;
                    var pathIndex     = value - currentHeight - 1; // Should be a negative number

                    if(pathIndex < -$.blockchain.path.length) {
                        alert("That block is out of reach due to the temporary checkpoint solution. Lowest possible block: " + $.blockchain.path[0].toHex());
                    }
                    if(pathIndex > -1) {
                        alert("That block has not been mined yet.");
                    }

                    var blockHash = $.blockchain.path.slice(pathIndex)[0];

                    _getBlockInfo(blockHash, function(blockInfo) {
                        if(!blockInfo) {
                            alert("Cannot find block.");
                        }
                        // console.log(blockInfo);

                        document.getElementById('infobox').innerHTML = tmpl.blockInfo(blockInfo);
                    });
                    break;
                default:
                    alert("Format cannot be detected");
            }
        });
    </script>
</body>
</html>
